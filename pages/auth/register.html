<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0">
    <title>Registro - MediRecord Pro</title>
    <link rel="stylesheet"
          href="../../assets/css/style.css">
    <link rel="stylesheet"
          href="../../assets/css/auth.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../assets/js/supabase-config.js"></script>
    <script src="../../assets/js/auth.js"></script>
</head>

<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>Crear Cuenta</h1>
                <p>√önete a MediRecord Pro</p>
            </div>

            <form id="registerForm"
                  class="auth-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">Nombre</label>
                        <input type="text"
                               id="firstName"
                               name="firstName"
                               required
                               placeholder="Tu nombre">
                    </div>
                    <div class="form-group">
                        <label for="lastName">Apellido</label>
                        <input type="text"
                               id="lastName"
                               name="lastName"
                               required
                               placeholder="Tu apellido">
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">Correo Electr√≥nico</label>
                    <input type="email"
                           id="email"
                           name="email"
                           required
                           placeholder="ejemplo@correo.com">
                </div>

                <div class="form-group">
                    <label for="phone">Tel√©fono</label>
                    <input type="tel"
                           id="phone"
                           name="phone"
                           required
                           placeholder="+52 123 456 7890">
                </div>

                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <div class="password-input">
                        <input type="password"
                               id="password"
                               name="password"
                               required
                               placeholder="M√≠nimo 6 caracteres">
                        <button type="button"
                                class="toggle-password"
                                onclick="togglePassword('password')">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirmar Contrase√±a</label>
                    <div class="password-input">
                        <input type="password"
                               id="confirmPassword"
                               name="confirmPassword"
                               required
                               placeholder="Repite tu contrase√±a">
                        <button type="button"
                                class="toggle-password"
                                onclick="togglePassword('confirmPassword')">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Tipo de Usuario</label>
                    <div class="role-selection">
                        <div class="role-option"
                             onclick="selectRole('patient')">
                            <input type="radio"
                                   id="patient"
                                   name="role"
                                   value="patient"
                                   checked>
                            <label for="patient">Paciente</label>
                        </div>
                        <div class="role-option"
                             onclick="selectRole('doctor')">
                            <input type="radio"
                                   id="doctor"
                                   name="role"
                                   value="doctor">
                            <label for="doctor">M√©dico</label>
                        </div>
                        <div class="role-option"
                             onclick="selectRole('nurse')">
                            <input type="radio"
                                   id="nurse"
                                   name="role"
                                   value="nurse">
                            <label for="nurse">Enfermero/a</label>
                        </div>
                        <div class="role-option"
                             onclick="selectRole('staff')">
                            <input type="radio"
                                   id="staff"
                                   name="role"
                                   value="staff">
                            <label for="staff">Personal</label>
                        </div>
                    </div>
                </div>

                <div id="doctorFields"
                     class="doctor-fields"
                     style="display: none;">
                    <div class="form-group">
                        <label for="specialty">Especialidad</label>
                        <select id="specialty"
                                name="specialty">
                            <option value="">Selecciona una especialidad</option>
                            <option value="medicina_general">Medicina General</option>
                            <option value="cardiologia">Cardiolog√≠a</option>
                            <option value="neurologia">Neurolog√≠a</option>
                            <option value="pediatria">Pediatr√≠a</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="licenseNumber">N√∫mero de C√©dula</label>
                        <input type="text"
                               id="licenseNumber"
                               name="licenseNumber"
                               placeholder="N√∫mero de c√©dula profesional">
                    </div>
                </div>

                <div id="patientFields"
                     class="patient-fields"
                     style="display: block;">
                    <div class="form-group">
                        <label for="birthDate">Fecha de Nacimiento</label>
                        <input type="date"
                               id="birthDate"
                               name="birthDate">
                    </div>
                    <div class="form-group">
                        <label for="gender">G√©nero</label>
                        <select id="gender"
                                name="gender">
                            <option value="">Selecciona tu g√©nero</option>
                            <option value="masculino">Masculino</option>
                            <option value="femenino">Femenino</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="maritalStatus">Estado Civil</label>
                        <select id="maritalStatus"
                                name="maritalStatus">
                            <option value="">Selecciona tu estado civil</option>
                            <option value="soltero">Soltero/a</option>
                            <option value="casado">Casado/a</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="occupation">Ocupaci√≥n</label>
                        <input type="text"
                               id="occupation"
                               name="occupation"
                               placeholder="Tu ocupaci√≥n">
                    </div>
                    <div class="form-group">
                        <label for="bloodType">Tipo de Sangre</label>
                        <select id="bloodType"
                                name="bloodType">
                            <option value="">Selecciona</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rhFactor">Factor RH</label>
                        <select id="rhFactor"
                                name="rhFactor">
                            <option value="">Selecciona</option>
                            <option value="positivo">Positivo</option>
                            <option value="negativo">Negativo</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-container">
                        <input type="checkbox"
                               id="terms"
                               required>
                        <span class="checkmark"></span>
                        Acepto los <a href="#"
                           target="_blank">t√©rminos y condiciones</a>
                    </label>
                </div>

                <div id="messageContainer"
                     class="message-container"></div>

                <button type="submit"
                        id="registerButton"
                        class="btn btn-primary btn-block"
                        data-original-text="Crear Cuenta">
                    Crear Cuenta
                </button>
            </form>

            <div class="auth-footer">
                <p>¬øYa tienes una cuenta?
                    <a href="login.html">Inicia sesi√≥n aqu√≠</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        // --- MANEJO DE LA INTERFAZ DE USUARIO (UI) ---

        /**
         * Muestra u oculta los campos del formulario seg√∫n el rol seleccionado.
         * Tambi√©n gestiona qu√© campos son obligatorios (required).
         * @param {string} role - El rol seleccionado ('patient', 'doctor', etc.).
         */
        function selectRole(role) {
            const doctorFields = document.getElementById('doctorFields');
            const patientFields = document.getElementById('patientFields');

            document.querySelectorAll('.role-option').forEach(option => {
                option.classList.remove('selected');
            });

            const selectedInput = document.querySelector(`input[value="${role}"]`);
            if (selectedInput) {
                selectedInput.checked = true;
                selectedInput.closest('.role-option').classList.add('selected');
            }

            // Resetear todos los campos opcionales a no requeridos
            document.getElementById('specialty').required = false;
            document.getElementById('licenseNumber').required = false;
            document.getElementById('birthDate').required = false;
            document.getElementById('gender').required = false;
            document.getElementById('maritalStatus').required = false;
            document.getElementById('occupation').required = false;
            document.getElementById('bloodType').required = false;
            document.getElementById('rhFactor').required = false;

            doctorFields.style.display = 'none';
            patientFields.style.display = 'none';

            // Activar los campos seg√∫n el rol
            if (role === 'doctor') {
                doctorFields.style.display = 'block';
                document.getElementById('specialty').required = true;
                document.getElementById('licenseNumber').required = true;
            } else if (role === 'patient') {
                patientFields.style.display = 'block';
                document.getElementById('birthDate').required = true;
                document.getElementById('gender').required = true;
                document.getElementById('maritalStatus').required = true;
                document.getElementById('occupation').required = true;
                document.getElementById('bloodType').required = true;
                document.getElementById('rhFactor').required = true;
            }
        }

        /**
         * Cambia la visibilidad de un campo de contrase√±a.
         * @param {string} inputId - El ID del input de la contrase√±a.
         */
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Al cargar la p√°gina, se selecciona el rol de 'paciente' por defecto.
        document.addEventListener('DOMContentLoaded', () => {
            selectRole('patient');
        });


        // --- MANEJO DEL ENV√çO DEL FORMULARIO ---

        /**
         * Escucha el evento 'submit' del formulario de registro.
         * Valida los datos y los env√≠a a Supabase.
         */
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading('registerButton', true);

            const formData = new FormData(e.target);
            const firstName = formData.get('firstName');
            const lastName = formData.get('lastName');
            const email = formData.get('email');
            const phone = formData.get('phone');
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');
            const role = formData.get('role');

            if (!authManager.isValidEmail(email) || !authManager.isValidPassword(password) || password !== confirmPassword) {
                showMessage('messageContainer', 'Por favor, revisa tus datos. Las contrase√±as deben coincidir y tener al menos 6 caracteres.');
                showLoading('registerButton', false);
                return;
            }

            // Crear el objeto de usuario para la tabla 'users'
            const userData = {
                full_name: `${firstName} ${lastName}`,
                phone: phone,
                role: role,
                specialty: role === 'doctor' ? formData.get('specialty') : null,
                license_number: role === 'doctor' ? formData.get('licenseNumber') : null
            };

            // Intentar registrar al usuario
            const result = await authManager.signUp(email, password, userData);

            if (result.success) {
                // Si el registro fue exitoso y el rol es 'paciente', guardar sus datos adicionales
                if (role === 'patient' && result.data.user) {
                    try {
                        const patientData = {
                            user_id: result.data.user.id,
                            birth_date: formData.get('birthDate'),
                            gender: formData.get('gender'),
                            marital_status: formData.get('maritalStatus'),
                            occupation: formData.get('occupation'),
                            blood_type: formData.get('bloodType'),
                            rh_factor: formData.get('rhFactor')
                        };

                        const { error: patientError } = await window.supabase.from('patients').insert([patientData]);

                        if (patientError) throw patientError;

                    } catch (error) {
                        showMessage('messageContainer', `El usuario se cre√≥, pero fall√≥ al guardar los detalles: ${error.message}`);
                        showLoading('registerButton', false);
                        return;

                    }
                }

                showMessage('messageContainer', '¬°Registro exitoso! Revisa tu correo para verificar tu cuenta.', 'success');
                document.getElementById('registerForm').reset();
                selectRole('patient');

            } else {
                showMessage('messageContainer', `Error en el registro: ${result.error.message || result.error}`);
            }

            showLoading('registerButton', false);
        });
    </script>

</body>

</html>
